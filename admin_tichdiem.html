<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Qu·∫£n tr·ªã ‚Äì T√≠ch ƒëi·ªÉm kh√°ch h√†ng | Aurora Spa</title>
  <style>
    :root{
      --green:#3f5846; --green-600:#395947; --green-700:#2f4032;
      --cream:#f6f6f4; --panel:#ffffff; --accent:#f5d979; --border:#eaeaea; --txt:#2d3a2e;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:Poppins,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:var(--txt);display:flex;background:var(--cream)}

    /* Sidebar */
    .sidebar{width:240px;background:var(--green);color:#fff;display:flex;flex-direction:column}
    .brand{padding:20px 24px;font-weight:700;font-size:20px;letter-spacing:.5px}
    .menu{display:flex;flex-direction:column;gap:4px;padding:8px 8px 16px}
    .menu a{display:flex;align-items:center;gap:10px;padding:12px 16px;border-radius:8px;color:#fff;text-decoration:none;font-size:14px;opacity:.95}
    .menu a.active,.menu a:hover{background:var(--green-700);border-left:4px solid var(--accent)}
    .menu .icon{width:18px;height:18px;display:inline-block}
    .help{margin-top:auto;padding:12px 16px;color:#dfe6e1;font-size:13px;border-top:1px solid rgba(255,255,255,.15)}

    /* Main */
    .main{flex:1;display:flex;flex-direction:column;min-width:0}
    .topbar{display:flex;align-items:center;justify-content:space-between;padding:26px 36px}
    .title{font-size:32px;color:var(--green-600);font-weight:500;letter-spacing:.3px}
    .top-right{display:flex;align-items:center;gap:14px}
    .top-btn{position:relative;width:36px;height:36px;border-radius:10px;border:1px solid var(--border);background:#fff;display:grid;place-items:center;cursor:pointer}
    .dot{position:absolute;top:6px;right:6px;width:7px;height:7px;border-radius:50%;background:#ffd34d}

    /* Toolbar */
    .toolbar{display:flex;align-items:center;gap:12px;padding:0 36px 16px;flex-wrap:wrap}
    .btn{background:#f1f2f0;border:1px solid #d6d8d5;border-radius:8px;padding:10px 14px;font-size:15px;cursor:pointer}
    .btn.primary{background:#eef2ed}
    .btn.success{background:#e8f3ea;border-color:#cfe3d2;color:#2f6b3a}
    .btn.warn{background:#fcebea;border-color:#f4c9c5;color:#a23b33}
    .btn.danger{background:#b53d3d;color:#fff;border:none}
    .search{margin-left:auto;display:flex;align-items:center}
    .search input{width:320px;padding:10px 12px;border:1px solid var(--border);border-radius:8px 0 0 8px;background:#fff}
    .search .filter{border:1px solid var(--border);border-left:none;border-radius:0 8px 8px 0;background:#fff;width:44px;height:40px;display:grid;place-items:center;cursor:pointer}

    /* Bulk bar */
    .bulk{display:none;align-items:center;gap:10px;margin:0 36px 12px;padding:10px;border:1px dashed var(--border);border-radius:8px;background:#fafafa}
    .bulk.show{display:flex}

    /* Card/Table */
    .card{background:var(--panel);border-radius:12px;margin:0 36px 24px;border:1px solid var(--border);overflow:hidden}
    .table-wrap{width:100%;overflow-x:auto}
    table{width:100%;border-collapse:separate;border-spacing:0;table-layout:fixed}
    col.checkbox{width:56px}
    col.code{width:110px}
    col.points{width:130px}
    col.update{width:210px}
    col.actions{width:140px}
    thead th{font-weight:600;text-align:left;background:#fafafa;border-bottom:1px solid var(--border);padding:14px 18px;color:#3a4b3d;white-space:nowrap}
    tbody td{padding:14px 18px;border-bottom:1px solid var(--border);font-size:14px;vertical-align:middle;white-space:nowrap}
    tbody tr:hover{background:#fbfbfb}
    .center{text-align:center}
    .cell-ellipsis{overflow:hidden;text-overflow:ellipsis}

    /* Action buttons with SVG */
    .kebab .act{border:1px solid var(--border);background:#fff;border-radius:10px;padding:8px;cursor:pointer;display:inline-grid;place-items:center}
    .icon-btn{width:16px;height:16px;stroke:#395947;fill:none;stroke-width:1.6px}
    .icon-trash{stroke:#b53d3d}

    /* Checkboxes */
    input[type="checkbox"]{accent-color:#395947;cursor:pointer}

    /* Card footer (pager) */
    .card-footer{display:flex;align-items:center;justify-content:center;gap:18px;padding:12px;border-top:1px solid var(--border)}
    .pg{width:34px;height:34px;display:grid;place-items:center;border:1px solid var(--border);border-radius:10px;background:#fff;cursor:pointer}

    /* Modal */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;padding:16px;z-index:50}
    .modal.open{display:flex}
    .dialog{background:#fff;border-radius:16px;padding:22px 24px;max-width:520px;width:min(92%,520px);box-shadow:0 10px 30px rgba(0,0,0,.15)}
    .dialog h3{margin:0 0 10px;color:var(--green-600);font-weight:600}
    .field{display:grid;grid-template-columns:140px 1fr;gap:10px;align-items:center;margin:10px 0}
    .input{width:100%;border:1px solid var(--border);border-radius:8px;padding:10px 12px;background:#fff}
    .actions{display:flex;justify-content:flex-end;gap:10px;margin-top:14px}

    /* Detail modal */
    .detail-list{border:1px solid var(--border);border-radius:10px;overflow:hidden}
    .detail-list table{table-layout:auto}
    .badge{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;border:1px solid var(--border);background:#fff}
    .badge .dot{position:static;width:8px;height:8px}

    @media (max-width:1000px){
      .search{margin-left:0;width:100%}
      .search input{flex:1;width:100%}
      .field{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="brand">Aurora Spa</div>
    <nav class="menu">
      <a href="#"><span class="icon">üë§</span>Kh√°ch h√†ng</a>
      <a href="#"><span class="icon">üíà</span>D·ªãch v·ª•</a>
      <a href="#"><span class="icon">üì∞</span>Blog</a>
      <a href="#"><span class="icon">üìÖ</span>L·ªãch h·∫πn</a>
      <a href="#"><span class="icon">‚ùì</span>FAQ</a>
      <a href="#" class="active"><span class="icon">üè∑Ô∏è</span>T√≠ch ƒëi·ªÉm</a>
      <a href="#"><span class="icon">‚öôÔ∏è</span>C√†i ƒë·∫∑t</a>
    </nav>
    <div class="help">Help</div>
  </aside>

  <!-- Main -->
  <main class="main">
    <div class="topbar">
      <div class="title">DANH S√ÅCH T√çCH ƒêI·ªÇM KH√ÅCH H√ÄNG</div>
      <div class="top-right">
        <div class="search">
          <input id="searchInput" type="search" placeholder="T√¨m kh√°ch h√†ng theo t√™n/SƒêT/email/M√£ KH" />
          <div class="filter" title="B·ªô l·ªçc">‚ò∞</div>
        </div>
        <button class="top-btn" title="Th√¥ng b√°o"><svg class="icon-btn" viewBox="0 0 24 24"><path d="M6 8a6 6 0 0 1 12 0v5l2 2H4l2-2V8"/><path d="M9 19a3 3 0 0 0 6 0"/></svg><span class="dot"></span></button>
        <button class="top-btn" title="Tin nh·∫Øn"><svg class="icon-btn" viewBox="0 0 24 24"><path d="M21 15a4 4 0 0 1-4 4H8l-5 4V6a4 4 0 0 1 4-4h10a4 4 0 0 1 4 4z"/></svg></button>
        <button class="top-btn" title="T√†i kho·∫£n"><svg class="icon-btn" viewBox="0 0 24 24"><circle cx="12" cy="8" r="4"/><path d="M20 20a8 8 0 1 0-16 0"/></svg></button>
      </div>
    </div>

    <div class="toolbar">
      <button class="btn primary" id="btnAddCustomer">+ Th√™m kh√°ch h√†ng m·ªõi</button>
      <button class="btn success" id="btnBulkAdd">C·ªông ƒëi·ªÉm</button>
      <button class="btn warn" id="btnBulkMinus">Tr·ª´ ƒëi·ªÉm</button>
      <button class="btn" id="btnExport">Xu·∫•t CSV</button>
      <button class="btn" id="btnImport">Nh·∫≠p CSV</button>
      <input id="csvFile" type="file" accept=".csv" style="display:none" />
    </div>

    <!-- Bulk actions info -->
    <div id="bulkBar" class="bulk">
      <div id="bulkCount">0 m·ª•c ƒë√£ ch·ªçn</div>
      <span class="badge"><span class="dot" style="background:#8bc34a"></span> c√≥ th·ªÉ c·ªông</span>
      <span class="badge"><span class="dot" style="background:#f44336"></span> c√≥ th·ªÉ tr·ª´</span>
      <div style="margin-left:auto"></div>
      <button class="btn success" id="bulkDoAdd">X√°c nh·∫≠n c·ªông</button>
      <button class="btn warn" id="bulkDoMinus">X√°c nh·∫≠n tr·ª´</button>
      <button class="btn" id="bulkClear">B·ªè ch·ªçn</button>
    </div>

    <!-- Table -->
    <div class="card">
      <div class="table-wrap">
        <table id="pointTable">
          <colgroup>
            <col class="checkbox" />
            <col class="code" />
            <col />
            <col />
            <col />
            <col class="points" />
            <col class="code" />
            <col class="update" />
            <col class="actions" />
          </colgroup>
          <thead>
            <tr>
              <th class="center"><input id="selectAll" type="checkbox" /></th>
              <th>M√£ KH</th>
              <th>T√™n kh√°ch h√†ng</th>
              <th>SƒêT</th>
              <th>Email</th>
              <th class="center">ƒêi·ªÉm hi·ªán t·∫°i</th>
              <th class="center">S·ªë GD ƒëi·ªÉm</th>
              <th>C·∫≠p nh·∫≠t g·∫ßn nh·∫•t</th>
              <th class="center">H√†nh ƒë·ªông</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
      <div class="card-footer">
        <div class="pg" id="pgPrev">‚Äπ</div>
        <div id="pgInfo">1</div>
        <div class="pg" id="pgNext">‚Ä∫</div>
      </div>
    </div>
  </main>

  <!-- Modal: C·ªông/Tr·ª´ ƒëi·ªÉm -->
  <div id="pointModal" class="modal" role="dialog" aria-modal="true">
    <div class="dialog">
      <h3 id="pmTitle">C·ªông ƒëi·ªÉm</h3>
      <div class="field"><label>S·ªë ƒëi·ªÉm</label><input id="pmAmount" type="number" class="input" placeholder="V√≠ d·ª•: 20" /></div>
      <div class="field"><label>L√Ω do</label><input id="pmReason" class="input" placeholder="V√≠ d·ª•: Ho√†n th√†nh ƒë∆°n #HD2031" /></div>
      <div class="actions">
        <button class="btn" id="pmCancel">H·ªßy</button>
        <button class="btn success" id="pmConfirm">X√°c nh·∫≠n</button>
      </div>
    </div>
  </div>

  <!-- Modal: Chi ti·∫øt kh√°ch h√†ng -->
  <div id="detailModal" class="modal" role="dialog" aria-modal="true">
    <div class="dialog" style="max-width:780px;width:min(94%,780px)">
      <h3>Chi ti·∫øt t√≠ch ƒëi·ªÉm ‚Äì <span id="dtName"></span> (<span id="dtCode"></span>)</h3>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px 18px;margin-bottom:12px">
        <div><b>SƒêT:</b> <span id="dtPhone"></span></div>
        <div><b>Email:</b> <span id="dtEmail"></span></div>
        <div><b>ƒêi·ªÉm hi·ªán t·∫°i:</b> <span id="dtPoints"></span></div>
        <div><b>S·ªë GD ƒëi·ªÉm:</b> <span id="dtTx"></span></div>
      </div>
      <div class="detail-list">
        <table style="width:100%;border-collapse:collapse">
          <thead style="background:#fafafa"><tr><th style="padding:10px 12px;text-align:left">Th·ªùi gian</th><th style="padding:10px 12px;text-align:left">Ho·∫°t ƒë·ªông</th><th style="padding:10px 12px;text-align:right">ƒêi·ªÉm</th></tr></thead>
          <tbody id="dtBody"></tbody>
        </table>
      </div>
      <div class="actions">
        <button class="btn" id="dtClose">ƒê√≥ng</button>
      </div>
    </div>
  </div>

  <!-- Modal: X√°c nh·∫≠n x√≥a -->
  <div id="confirmDeleteModal" class="modal" role="dialog" aria-modal="true">
    <div class="dialog">
      <h3>X√°c nh·∫≠n x√≥a</h3>
      <p>B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a kh√°ch h√†ng n√†y kh√¥ng?</p>
      <div class="actions">
        <button class="btn" id="cancelDelete">H·ªßy</button>
        <button class="btn danger" id="confirmDelete">OK</button>
      </div>
    </div>
  </div>

  <!-- Modal: Th√™m kh√°ch h√†ng -->
  <div id="addCustomerModal" class="modal" role="dialog" aria-modal="true">
    <div class="dialog">
      <h3>Th√™m kh√°ch h√†ng m·ªõi</h3>
      <div class="field"><label>T√™n kh√°ch h√†ng *</label><input id="newName" class="input" placeholder="Nh·∫≠p t√™n kh√°ch h√†ng"></div>
      <div class="field"><label>SƒêT *</label><input id="newPhone" class="input" placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i"></div>
      <div class="field"><label>Email (kh√¥ng b·∫Øt bu·ªôc)</label><input id="newEmail" class="input" placeholder="Nh·∫≠p email kh√°ch h√†ng (n·∫øu c√≥)"></div>
      <div class="actions">
        <button class="btn" id="cancelAdd">H·ªßy</button>
        <button class="btn success" id="confirmAdd">Th√™m</button>
      </div>
    </div>
  </div>

  <script>
    // ===== Demo data =====
    const customers = [
      {code:'KH001', name:'Nguy·ªÖn Ph√∫c Th·∫Øm', phone:'0905 123 456', email:'tham.nguyen@example.com', points:125, tx:12, updated:'09:00:00 25/09/2025', history:[
        {time:'24/09/2025 09:00', note:'Ho√†n th√†nh ƒë∆°n #HD2031', delta:+20},
        {time:'15/09/2025 10:12', note:'Quy ƒë·ªïi phi·∫øu gi·∫£m 50K', delta:-50},
        {time:'05/09/2025 14:32', note:'Gi·ªõi thi·ªáu b·∫°n b√®', delta:+30}
      ]},
      {code:'KH002', name:'Tr·∫ßn Thu H√†', phone:'0902 888 777', email:'ha.tran@example.com', points:80, tx:7, updated:'10:44:11 21/09/2025', history:[
        {time:'20/09/2025 11:20', note:'Ho√†n th√†nh ƒë∆°n #HD2001', delta:+15}
      ]},
      {code:'KH003', name:'Ph·∫°m Nh·∫≠t Minh', phone:'0912 222 333', email:'minh.pn@example.com', points:230, tx:18, updated:'08:21:05 18/09/2025', history:[
        {time:'18/09/2025 08:20', note:'Quy ƒë·ªïi phi·∫øu 100K', delta:-100}
      ]},
      {code:'KH004', name:'L√™ B·∫£o Long', phone:'0935 999 111', email:'long.lb@example.com', points:45, tx:3, updated:'16:00:00 10/09/2025', history:[]},
      {code:'KH005', name:'ƒê·∫∑ng H·∫£i Y·∫øn', phone:'0987 456 321', email:'yen.dh@example.com', points:150, tx:9, updated:'13:05:00 07/09/2025', history:[]},
      {code:'KH006', name:'V√µ Qu·ªëc Huy', phone:'0934 111 222', email:'huy.vq@example.com', points:60, tx:5, updated:'12:30:40 02/09/2025', history:[]}
    ];

    // ===== State =====
    let currentPage = 1; const pageSize = 5;
    let selected = new Set();
    let mode = 'add'; // 'add' | 'minus'
    let bulk = false; // apply to selected or single row
    let targetCode = null; // single row target
    let deleteTarget = null; // for confirm delete

    const el = s => document.querySelector(s);
    const els = s => Array.from(document.querySelectorAll(s));
    const fmtNow = () => new Date().toLocaleTimeString('vi-VN',{hour12:false})+' '+new Date().toLocaleDateString('vi-VN');

    // ===== Filter helper (used for selection across pages) =====
    function currentFiltered(){
      const q = el('#searchInput').value.toLowerCase().trim();
      return customers.filter(c => !q || c.code.toLowerCase().includes(q) || c.name.toLowerCase().includes(q) || c.phone.includes(q) || (c.email||'').toLowerCase().includes(q));
    }

    // ===== Render table =====
    function render(){
      const filtered = currentFiltered();
      const totalPages = Math.max(1, Math.ceil(filtered.length/pageSize));
      currentPage = Math.min(currentPage, totalPages);
      const start = (currentPage-1)*pageSize;
      const rows = filtered.slice(start, start+pageSize);

      el('#tbody').innerHTML = rows.map(c=>`
        <tr data-code="${c.code}">
          <td class="center"><input class="rowSel" type="checkbox" ${selected.has(c.code)?'checked':''}></td>
          <td>${c.code}</td>
          <td class="cell-ellipsis"><a href="#" class="linkName">${c.name}</a></td>
          <td>${c.phone}</td>
          <td class="cell-ellipsis" title="${c.email||''}">${c.email||''}</td>
          <td class="center">${c.points}</td>
          <td class="center">${c.tx}</td>
          <td>${c.updated}</td>
          <td class="center kebab">
            <button class="act" data-act="add" title="C·ªông ƒëi·ªÉm"><svg class="icon-btn" viewBox="0 0 24 24"><path d="M12 5v14M5 12h14"/></svg></button>
            <button class="act" data-act="minus" title="Tr·ª´ ƒëi·ªÉm"><svg class="icon-btn" viewBox="0 0 24 24"><path d="M5 12h14"/></svg></button>
            <button class="act" data-act="delete" title="X√≥a"><svg class="icon-btn icon-trash" viewBox="0 0 24 24"><path d="M3 6h18"/><path d="M8 6V4h8v2"/><path d="M6 6l1 14h10l1-14"/></svg></button>
          </td>
        </tr>`).join('');

      // Row interactions
      els('#tbody tr').forEach(tr=>{
        // open detail when clicking name link
        tr.querySelector('.linkName').addEventListener('click', (e)=>{
          e.preventDefault(); e.stopPropagation();
          openDetail(tr.dataset.code);
        });
        // checkboxes
        const cb = tr.querySelector('.rowSel');
        cb.addEventListener('click', e=>e.stopPropagation());
        cb.addEventListener('change', e=>{
          const code = tr.dataset.code; if(e.target.checked) selected.add(code); else selected.delete(code); updateBulkBar(); updateSelectAllState();
        });
        // action buttons
        tr.querySelectorAll('.kebab .act').forEach(btn=>btn.addEventListener('click', ev=>{
          ev.stopPropagation();
          const code = tr.dataset.code;
          const act = btn.dataset.act;
          if(act==='add'||act==='minus'){ openPointModal(act, false, code); }
          if(act==='delete') openDeleteModal(code);
        }));
      });

      // Global Select All (applies to entire filtered dataset)
      updateSelectAllState();

      el('#pgInfo').textContent = currentPage;
    }

    function updateSelectAllState(){
      const filtered = currentFiltered();
      const all = el('#selectAll');
      const allSelected = filtered.length>0 && filtered.every(r=>selected.has(r.code));
      const someSelected = filtered.some(r=>selected.has(r.code));
      all.checked = allSelected;
      all.indeterminate = !allSelected && someSelected;
      all.onclick = (e)=>{
        e.stopPropagation();
        if(all.checked){ filtered.forEach(r=>selected.add(r.code)); } else { filtered.forEach(r=>selected.delete(r.code)); }
        render(); updateBulkBar();
      };
    }

    function updateBulkBar(){
      const bar = el('#bulkBar');
      const count = selected.size; el('#bulkCount').textContent = count + ' m·ª•c ƒë√£ ch·ªçn';
      bar.classList.toggle('show', count>0);
    }

    // ===== Modal: Add/Minus points =====
    function openPointModal(kind, isBulk=false, code=null){
      mode = kind; bulk = isBulk; targetCode = code;
      el('#pmTitle').textContent = (mode==='add'?'C·ªông ƒëi·ªÉm':'Tr·ª´ ƒëi·ªÉm') + (bulk?' (h√†ng lo·∫°t)':'');
      el('#pmAmount').value = '';
      el('#pmReason').value = '';
      el('#pointModal').classList.add('open');
      el('#pmAmount').focus();
    }

    function closePointModal(){ el('#pointModal').classList.remove('open'); }

    function applyPoints(amount, reason){
      if(!amount) return;
      const list = bulk ? customers.filter(c=>selected.has(c.code)) : customers.filter(c=>c.code===targetCode);
      const now = fmtNow();
      list.forEach(c=>{
        c.points += amount; c.tx += 1; c.updated = now;
        c.history.unshift({time: now.replace(',', ''), note: reason || (amount>0?'C·ªông ƒëi·ªÉm':'Tr·ª´ ƒëi·ªÉm'), delta: amount});
      });
      if(bulk) selected.clear();
      render(); updateBulkBar();
    }

    // ===== Modal: Detail =====
    function openDetail(code){
      const c = customers.find(x=>x.code===code); if(!c) return;
      el('#dtName').textContent = c.name; el('#dtCode').textContent = c.code;
      el('#dtPhone').textContent = c.phone; el('#dtEmail').textContent = c.email || '';
      el('#dtPoints').textContent = c.points; el('#dtTx').textContent = c.tx;
      el('#dtBody').innerHTML = c.history.map(h=>`<tr><td style="padding:10px 12px">${h.time}</td><td style="padding:10px 12px">${h.note}</td><td style="padding:10px 12px;text-align:right;${h.delta>0?'color:#2f6b3a':'color:#a23b33'}">${h.delta>0?'+':''}${h.delta}</td></tr>`).join('');
      el('#detailModal').classList.add('open');
    }
    function closeDetail(){ el('#detailModal').classList.remove('open'); }

    // ===== Delete confirm modal =====
    function openDeleteModal(code){ deleteTarget = code; el('#confirmDeleteModal').classList.add('open'); }
    function closeDeleteModal(){ deleteTarget = null; el('#confirmDeleteModal').classList.remove('open'); }
    el('#cancelDelete').onclick = closeDeleteModal;
    el('#confirmDelete').onclick = ()=>{
      if(deleteTarget){ const i=customers.findIndex(x=>x.code===deleteTarget); if(i>-1){ customers.splice(i,1); selected.delete(deleteTarget); } }
      closeDeleteModal(); render(); updateBulkBar();
    };

    // ===== Add customer modal =====
    el('#btnAddCustomer').onclick = ()=> el('#addCustomerModal').classList.add('open');
    el('#cancelAdd').onclick = ()=> el('#addCustomerModal').classList.remove('open');
    el('#confirmAdd').onclick = ()=>{
      const name = el('#newName').value.trim();
      const phone = el('#newPhone').value.trim();
      const email = el('#newEmail').value.trim();
      if(!name || !phone){ alert('Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß T√™n v√† SƒêT!'); return; }
      const nextNum = Math.max(0,...customers.map(d=>+d.code.replace(/\D/g,'')))+1;
      const code = 'KH'+String(nextNum).padStart(3,'0');
      customers.unshift({code, name, phone, email: email||'', points:0, tx:0, updated:fmtNow(), history:[]});
      currentPage = 1; el('#addCustomerModal').classList.remove('open'); render();
      el('#newName').value=''; el('#newPhone').value=''; el('#newEmail').value='';
    };

    // ===== CSV Export/Import =====
    function toCSV(rows){
      const header = ['code','name','phone','email','points','tx','updated'];
      const lines = [header.join(',')];
      rows.forEach(c=>{ lines.push([c.code,c.name,c.phone,c.email||'',c.points,c.tx,c.updated].map(v=>`"${String(v).replace(/"/g,'""')}"`).join(',')); });
      return lines.join('\n');
    }
    el('#btnExport').onclick = ()=>{
      const csv = toCSV(customers);
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download='customers.csv'; a.click(); URL.revokeObjectURL(url);
    };
    el('#btnImport').onclick = ()=> el('#csvFile').click();
    el('#csvFile').addEventListener('change', (e)=>{
      const file = e.target.files[0]; if(!file) return;
      const reader = new FileReader();
      reader.onload = (ev)=>{
        const text = ev.target.result; importCSV(text);
        e.target.value = '';
      };
      reader.readAsText(file);
    });
    function importCSV(text){
      const lines = text.split(/\r?\n/).filter(Boolean);
      if(lines.length<2) return;
      const header = lines[0].split(',').map(h=>h.trim().replace(/^"|"$/g,''));
      const idx = k=> header.indexOf(k);
      for(let i=1;i<lines.length;i++){
        const cols = splitCSVLine(lines[i]);
        const obj = {
          code: cols[idx('code')]?.replace(/^"|"$/g,'') || null,
          name: (cols[idx('name')]||'').replace(/^"|"$/g,''),
          phone: (cols[idx('phone')]||'').replace(/^"|"$/g,''),
          email: (cols[idx('email')]||'').replace(/^"|"$/g,''),
          points: parseInt((cols[idx('points')]||'0'),10) || 0,
          tx: parseInt((cols[idx('tx')]||'0'),10) || 0,
          updated: (cols[idx('updated')]||fmtNow()).replace(/^"|"$/g,'')
        };
        if(!obj.name || !obj.phone) continue; // y√™u c·∫ßu t·ªëi thi·ªÉu
        if(!obj.code){ const nextNum = Math.max(0,...customers.map(d=>+d.code.replace(/\D/g,'')))+1; obj.code='KH'+String(nextNum).padStart(3,'0'); }
        customers.push(obj);
      }
      render();
    }
    // t√°ch 1 d√≤ng CSV, h·ªó tr·ª£ d·∫•u ph·∫©y trong chu·ªói c√≥ d·∫•u nh√°y
    function splitCSVLine(line){
      const out=[]; let cur=''; let inQ=false;
      for(let i=0;i<line.length;i++){
        const ch=line[i];
        if(ch==='"'){
          if(inQ && line[i+1]==='"'){ cur+='"'; i++; }
          else inQ=!inQ;
        } else if(ch===',' && !inQ){ out.push(cur); cur=''; }
        else cur+=ch;
      }
      out.push(cur);
      return out;
    }

    // ===== Events =====
    el('#searchInput').oninput = ()=>{ currentPage=1; render(); };
    el('#pgPrev').onclick = ()=>{ if(currentPage>1){ currentPage--; render(); } };
    el('#pgNext').onclick = ()=>{
      const filtered=currentFiltered(); const total=Math.ceil(filtered.length/pageSize); if(currentPage<total){ currentPage++; render(); }
    };

    // bulk buttons (open modal)
    el('#btnBulkAdd').onclick = ()=> openPointModal('add', true);
    el('#btnBulkMinus').onclick = ()=> openPointModal('minus', true);
    el('#bulkDoAdd').onclick = ()=> openPointModal('add', true);
    el('#bulkDoMinus').onclick = ()=> openPointModal('minus', true);
    el('#bulkClear').onclick = ()=>{ selected.clear(); updateBulkBar(); render(); };

    // point modal buttons
    el('#pmCancel').onclick = ()=> el('#pointModal').classList.remove('open');
    el('#pmConfirm').onclick = ()=>{
      const raw = parseInt(el('#pmAmount').value,10);
      const reason = el('#pmReason').value.trim();
      if(!Number.isFinite(raw) || raw===0){ alert('Vui l√≤ng nh·∫≠p s·ªë ƒëi·ªÉm h·ª£p l·ªá (‚â† 0)'); return; }
      applyPoints(mode==='add'? Math.abs(raw) : -Math.abs(raw), reason);
      el('#pointModal').classList.remove('open');
    };

    // detail modal close
    el('#dtClose').onclick = ()=> el('#detailModal').classList.remove('open');

    // init
    render();
  </script>
</body>
</html>
